PBX IP Asterisk com OpenR2 no Ubuntu Server 12.04 i386

Neste post estou explicando como instalar o Asterisk com OpenR2 no Ubuntu Server 12.04 i386, para este cénario estou utilizando as seguintes versões:
	•	certified-asterisk-1.8.15-cert1
	•	dahdi-linux-complete-2.6.1 + 2.6.1
	•	libpri-1.4.14
	•	openr2-1.3.2
	•	ubuntu server 12.04 i386
	•	Placa TE220 dual-span T1/E1/J1
	•	
Após a instalação do sistema operativo faça um “update” e depois um “upgrade”. Em seguinda reinicie o servidor.
# apt-get update
# apt-get upgrade
# reboot

Pacotes essenciais:
# apt-get install -y build-essential ncurses-dev ncurses-term libcurl4-openssl-dev bison
# apt-get install -y libxml2-dev zlib1g-dev zlib-bin libncurses5-dev   
# apt-get install -y libmysqlclient-dev postgresql-client libpq5 libpq-dev libssl-dev libtool
# apt-get install -y libasterisk-agi-perl libpg-perl libsqlite3-dev sqlite3 libvorbis-dev
# apt-get install -y gcc g++ make openssl zlib1g-dev libtermcap-dev unixodbc unixodbc-dev
# apt-get install -y automake mysql-serve mysql-client mysql-admin libmysqlclient15-dev 
# apt-get install -y curl libgnutls13 libgnutls-dev 
# apt-get install -y libtiff4-dev

Pacotes não essenciais:
# apt-get install -y tshark vim php5 php5-pgsql php5-mysql php5-cli php5-common php5-dev   
# apt-get install -y subversion subersion-tools postgresql htop pciutils screen
# apt-get install -y unixodbc unixodbc-bin unixodbc-dev speex libspeex-dev
# apt-get install -y libnewt-dev libnewt0.52 libdatetime-perl
# apt-get install -y linux-kernel-devel libasound2-dev libportaudio-dev libportaudio2 jackd
# apt-get install -y linux-headers-$(uname -r) 

Todas as versões dos pacotes utilizados aqui estão no site oficial do projeto Asterisk em download section. Com exceção do “OpenR2”, procedo com downloads dos pacotes, depois extraia os mesmos e execute a instalação.

Diretorio de trabalho:
# cd /usr/local/src/

Adquirindo os pacotes:
# wget http://downloads.asterisk.org/pub/telephony/dahdi-linux-complete/dahdi-linux-complete-current.tar.gz

# wget http://downloads.asterisk.org/pub/telephony/libpri/libpri-1.4-current.tar.gz

# wget http://openr2.googlecode.com/files/openr2-1.3.2.tar.gz

# wget http://downloads.asterisk.org/pub/telephony/certified-asterisk/certified-asterisk-1.8.15-current.tar.gz

Descompactando os pacotes:
# tar zxvf dahdi-linux-complete-current.tar.gz
# tar zxvf libpri-1.4-current.tar.gz
# tar zxvf certified-asterisk-1.8.15-current.tar.gz  
# tar zxvf openr2-1.3.2.tar.gz

Instalando os pacotes:
# cd dahdi-linux-complete-2.6.1+2.6.1
# make
# make install

# cd libpri-1.4.14
# make 
# make install

# cd openr2-1.3.2
# ./configure --prefix=/usr
# make 
# make install

# cd certified-asterisk-1.8.15-cert1
# ./configure
# make menuselect

Em “Add-ons (See README-addons.txt)” selecionar:
 					[*] app_mysql
					[*] app_saycountpl
					[*] cdr_mysql

OBS: para selecionar é com a tecla “<ENTER>”.

Em “PBX Modules” selecionar:
					[*] pbx_realtime

Em “Music On Hold File Packages” selecionar:
					[*] MOH-OPSOUND-GSM 

Em “Extras Sound Packages” selecionar:
					[*] EXTRA-SOUNDS-EN-GSM


Depois selecionar “Save & Exit”:



Então execute os procedimentos abaixo:
# make
# make install
# make samples
# make config

Para deixar seu servidor com IP fixo os procedimentos são os descritos abaixo:

root@pbxip:/# vim /etc/network/interfaces

------------------------------------------------------------------------------------------
# This file describes the network interfaces available on your system 
# and how to activate them. For more information, see interfaces(5). 

# The loopback network interface 
auto lo 
iface lo inet loopback 

# The primary network interface 
auto eth0 
iface eth0 inet static 
        address 192.168.0.111 
        network 192.168.0.0 
        netmask 255.255.255.0 
        gateway 192.168.0.1 
        broadcast 192.168.0.255 
------------------------------------------------------------------------------------------

root@pbxip:/# vim /etc/resolv.conf 

------------------------------------------------------------------------------------------
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) 
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN 
nameserver 192.168.0.1 
nameserver 8.8.8.8 
nameserver 8.8.4.4 

------------------------------------------------------------------------------------------

root@pbxip:/# reboot



Agora vamos identificar nossa placa de comutação:

root@pbxip:~# lspci 
00:00.0 Host bridge: Intel Corporation Core Processor DRAM Controller (rev 18)
00:01.0 PCI bridge: Intel Corporation Core Processor PCI Express x16 Root Port (rev 18)
00:1a.0 USB Controller: Intel Corporation 5 Series/3400 Series Chipset USB2 Enhanced Host Controller (rev 05)
00:1c.0 PCI bridge: Intel Corporation 5 Series/3400 Series Chipset PCI Express Root Port 1 (rev 05)
00:1c.4 PCI bridge: Intel Corporation 5 Series/3400 Series Chipset PCI Express Root Port 5 (rev 05)
00:1d.0 USB Controller: Intel Corporation 5 Series/3400 Series Chipset USB2 Enhanced Host Controller (rev 05)
00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev a5)
00:1f.0 ISA bridge: Intel Corporation 3400 Series Chipset LPC Interface Controller (rev 05)
00:1f.2 IDE interface: Intel Corporation 5 Series/3400 Series Chipset 4 port SATA IDE Controller (rev 05)
00:1f.5 IDE interface: Intel Corporation 5 Series/3400 Series Chipset 2 port SATA IDE Controller (rev 05)
01:03.0 VGA compatible controller: Matrox Graphics, Inc. MGA G200eW WPCM450 (rev 0a)
02:00.0 Ethernet controller: Broadcom Corporation NetXtreme II BCM5716 Gigabit Ethernet (rev 20)
02:00.1 Ethernet controller: Broadcom Corporation NetXtreme II BCM5716 Gigabit Ethernet (rev 20)
04:00.0 PCI bridge: Texas Instruments XIO2000(A)/XIO2200(A) PCI Express-to-PCI Bridge (rev 03)
05:08.0 Communication controller: Digium, Inc. Wildcard TE220 dual-span T1/E1/J1 card 3.3V (PCI-Express) (5th gen) (rev 02)
root@pbxip:~# 

Vamos configurar a placa:

root@pbxip:~# dahdi_cfg -vvvv

Vamos verificar dentro do Asterisk se todos os canais estão corretos:

root@pbxip:~#rasterisk -vvvvgciT
[Jan 25 12:02:49] Asterisk 1.8.11-cert7, Copyright (C) 1999 - 2012 Digium, Inc. and others.
Created by Mark Spencer <markster@digium.com>
Asterisk comes with ABSOLUTELY NO WARRANTY; type 'core show warranty' for details.
This is free software, with components licensed under the GNU General Public
License version 2 and other licenses; you are welcome to redistribute it under
certain conditions. Type 'core show license' for details.
======================================================================
[Jan 25 12:02:49]   == Parsing '/etc/asterisk/asterisk.conf': [Jan 25 12:02:49]   == Found
[Jan 25 12:02:49]   == Parsing '/etc/asterisk/extconfig.conf': [Jan 25 12:02:49]   == Found
[Jan 25 12:02:49] Connected to Asterisk 1.8.11-cert7 currently running on foneatrnp-maq3 (pid = 1425)
Verbosity is at least 4
pbxip*CLI> 


pbxip*CLI> mfcr2 show channels
Chan Variant Max ANI Max DNIS ANI First Immediate Accept Tx CAS   Rx CAS  
   1 BR      4       20       No        No               IDLE     0x08    
   2 BR      4       20       No        No               IDLE     0x08    
   3 BR      4       20       No        No               IDLE     0x08    
   4 BR      4       20       No        No               IDLE     0x08    
   5 BR      4       20       No        No               IDLE     0x08    
   6 BR      4       20       No        No               IDLE     0x08    
   7 BR      4       20       No        No               IDLE     0x08    
   8 BR      4       20       No        No               IDLE     0x08    
   9 BR      4       20       No        No               IDLE     0x08    
  10 BR      4       20       No        No               IDLE     0x08    
  11 BR      4       20       No        No               IDLE     0x08    
  12 BR      4       20       No        No               IDLE     0x08    
  13 BR      4       20       No        No               IDLE     0x08    
  14 BR      4       20       No        No               IDLE     0x08    
  15 BR      4       20       No        No               IDLE     0x08    
  17 BR      4       20       No        No               IDLE     0x08    
  18 BR      4       20       No        No               IDLE     0x08    
  19 BR      4       20       No        No               IDLE     0x08    
  20 BR      4       20       No        No               IDLE     0x08    
  21 BR      4       20       No        No               IDLE     0x08    
  22 BR      4       20       No        No               IDLE     0x08    
  23 BR      4       20       No        No               IDLE     0x08    
  24 BR      4       20       No        No               IDLE     0x08    
  25 BR      4       20       No        No               IDLE     0x08    
  26 BR      4       20       No        No               IDLE     0x08    
  27 BR      4       20       No        No               IDLE     0x08    
  28 BR      4       20       No        No               IDLE     0x08    
  29 BR      4       20       No        No               IDLE     0x08    
  30 BR      4       20       No        No               IDLE     0x08    
  31 BR      4       20       No        No               IDLE     0x08    
pbxip*CLI> 

pbxip*CLI> dahdi show channels
   Chan Extension  Context         Language   MOH Interpret        Blocked    State     
 pseudo            default                    default                         In Service
      1            from-pabx                  default                         In Service
      2            from-pabx                  default                         In Service
      3            from-pabx                  default                         In Service
      4            from-pabx                  default                         In Service
      5            from-pabx                  default                         In Service
      6            from-pabx                  default                         In Service
      7            from-pabx                  default                         In Service
      8            from-pabx                  default                         In Service
      9            from-pabx                  default                         In Service
     10            from-pabx                  default                         In Service
     11            from-pabx                  default                         In Service
     12            from-pabx                  default                         In Service
     13            from-pabx                  default                         In Service
     14            from-pabx                  default                         In Service
     15            from-pabx                  default                         In Service
     17            from-pabx                  default                         In Service
     18            from-pabx                  default                         In Service
     19            from-pabx                  default                         In Service
     20            from-pabx                  default                         In Service
     21            from-pabx                  default                         In Service
     22            from-pabx                  default                         In Service
     23            from-pabx                  default                         In Service
     24            from-pabx                  default                         In Service
     25            from-pabx                  default                         In Service
     26            from-pabx                  default                         In Service
     27            from-pabx                  default                         In Service
     28            from-pabx                  default                         In Service
     29            from-pabx                  default                         In Service
     30            from-pabx                  default                         In Service
     31            from-pabx                  default                         In Service
pbxip*CLI> 

Com isto sua placa e seu Asterisk estão configurados.

Caso não tenha informações satisfatórias verifique se os seus ficheiros estão iguais os meus.

root@pbxip:~# vim /etc/dahdi/system.conf

------------------------------------------------------------------------------------------
# Autogenerated by /usr/sbin/dahdi_genconf on Mon Dec  3 17:24:55 2012
# If you edit this file and execute /usr/sbin/dahdi_genconf again,
# your manual changes will be LOST.
# Dahdi Configuration File
#
# This file is parsed by the Dahdi Configurator, dahdi_cfg
#
# Span 1: TE2/0/1 "T2XXP (PCI) Card 0 Span 1" (MASTER) HDB3/CCS/CRC4 ClockSource 
span=1,1,0,cas,hdb3
# termtype: te
cas=1-15:1001
cas=17-31:1001

# Span 2: TE2/0/2 "T2XXP (PCI) Card 0 Span 2" HDB3/CCS/CRC4 RED 
#span=2,2,0,ccs,hdb3,crc4
# termtype: te
#bchan=32-46,48-62
#dchan=47
#echocanceller=mg2,32-46,48-62

# Global data

loadzone        = us
defaultzone     = us

------------------------------------------------------------------------------------------

root@pbxip:~# vim /etc/asterisk/chan_dahdi.conf

------------------------------------------------------------------------------------------
[trunkgroups]

[channels]

; Span 1: WCT1/0 "Wildcard TE122 Card 0" (MASTER)
group=1
context=from-pstn
signalling=mfcr2
mfcr2_variant=br
mfcr2_max_ani=4
mfcr2_max_dnis=20
mfcr2_get_ani_first=no
mfcr2_category=national
mfcr2_logdir=span1
mfcr2_logging=all
mfcr2_mfback_timeout=-1
mfcr2_metering_pulse_timeout=-1
mfcr2_allow_collect_calls=yes
mfcr2_double_answer=no
mfcr2_immediate_accept=no
mfcr2_accept_on_offer=yes
mfcr2_skip_category=no

; mfcr2_advanced_protocol_file=/path/to/r2proto.conf
mfcr2_forced_release=no
mfcr2_charge_calls=no
channel=>1-15,17-31
context=default
group=63
